{{- range .Values.stores }}
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: {{ .name }}
  labels:
    {{- include "external-secrets-stores.labels" $ | nindent 4 }}
    app.kubernetes.io/component: clustersecretstore
    external-secrets.io/provider: {{ .provider }}
spec:
  {{- if eq .provider "gcp" }}
  provider:
    gcpsm:
      projectID: {{ .gcp.projectId | required (printf "gcp.projectId is required for store %s" .name) | quote }}
      {{- if .gcp.auth.workloadIdentity.enabled }}
      auth:
        workloadIdentity:
          clusterLocation: {{ .gcp.auth.workloadIdentity.clusterLocation | required "clusterLocation required for Workload Identity" }}
          clusterName: {{ .gcp.auth.workloadIdentity.clusterName | required "clusterName required for Workload Identity" }}
          serviceAccountRef:
            name: {{ .gcp.auth.workloadIdentity.serviceAccountRef.name | default "external-secrets" }}
            namespace: {{ .gcp.auth.workloadIdentity.serviceAccountRef.namespace | default "external-secrets-system" }}
      {{- else if .gcp.auth.serviceAccountKey.enabled }}
      auth:
        secretRef:
          secretAccessKeySecretRef:
            name: {{ .gcp.auth.serviceAccountKey.secretRef.name | required "secretRef.name required for Service Account Key auth" }}
            key: {{ .gcp.auth.serviceAccountKey.secretRef.key | required "secretRef.key required for Service Account Key auth" }}
            namespace: {{ .gcp.auth.serviceAccountKey.secretRef.namespace | required "secretRef.namespace required for Service Account Key auth" }}
      {{- else }}
      {{- fail (printf "Either workloadIdentity or serviceAccountKey auth must be enabled for GCP store %s" .name) }}
      {{- end }}
  {{- else if eq .provider "aws" }}
  provider:
    aws:
      service: {{ .aws.service | default "SecretsManager" }}
      region: {{ .aws.region | required (printf "aws.region is required for store %s" .name) }}
      auth:
        jwt:
          serviceAccountRef:
            name: {{ .aws.auth.jwt.serviceAccountRef.name | default "external-secrets" }}
            namespace: {{ .aws.auth.jwt.serviceAccountRef.namespace | default "external-secrets-system" }}
  {{- else if eq .provider "azure" }}
  provider:
    azurekv:
      vaultUrl: {{ .azure.vaultUrl | required (printf "azure.vaultUrl is required for store %s" .name) }}
      {{- if .azure.tenantId }}
      tenantId: {{ .azure.tenantId }}
      {{- end }}
      {{- if .azure.auth.workloadIdentity.enabled }}
      authType: WorkloadIdentity
      serviceAccountRef:
        name: {{ .azure.auth.workloadIdentity.serviceAccountRef.name | default "external-secrets" }}
        namespace: {{ .azure.auth.workloadIdentity.serviceAccountRef.namespace | default "external-secrets-system" }}
      {{- else }}
      {{- fail (printf "Workload Identity auth must be enabled for Azure store %s" .name) }}
      {{- end }}
  {{- else }}
  {{- fail (printf "Unsupported provider '%s' for store %s. Supported providers: gcp, aws, azure" .provider .name) }}
  {{- end }}
{{- end }}
