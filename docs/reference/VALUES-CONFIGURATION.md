# Values Directory

This directory contains all actual configuration values used to deploy infrastructure and applications. Everything outside this directory should be treated as templates or examples.

## Directory Structure

```
values/
├── cluster/                # Cluster Terraform configuration (gitignored)
│   ├── main.tf            # Active cluster infrastructure code
│   ├── variables.tf       # Terraform variables
│   ├── outputs.tf         # Terraform outputs
│   └── terraform.tfvars   # Your cluster configuration values
├── infrastructure/         # Infrastructure configuration
│   └── main.yaml          # Main infrastructure config (ArgoCD, cert-manager, external-dns, gateway, etc.)
└── deployments/           # Application deployment configurations
    ├── acme-staging.yaml    # Example staging environment
    └── acme-production.yaml # Example production environment
```

## Usage

### Cluster Configuration

Cluster configuration is generated by the setup wizard or copied from examples:

```bash
# Interactive wizard (recommended)
mise run provision

# Or copy from examples
cp -r terraform/examples/gcp-gke values/cluster
cd values/cluster
vim terraform.tfvars
```

The `values/cluster/` directory is gitignored and contains your active cluster Terraform configuration.

### Infrastructure Configuration

Infrastructure values are referenced by ArgoCD applications in `charts/argocd-infrastructure/`:

```yaml
# charts/argocd-bootstrap/infrastructure-root.yaml
helm:
  valueFiles:
    - ../../values/infrastructure/main.yaml
```

### Deployment Configuration

Deployment values are automatically discovered by the ApplicationSet in `charts/argocd-bootstrap/applicationset-auto-discover.yaml`.

The ApplicationSet uses a **Git Files Generator** to scan `values/deployments/*.yaml` files:

```yaml
generators:
  - git:
      files:
        - path: "values/deployments/*.yaml"
```

Each YAML file discovered creates a corresponding ArgoCD Application.

## Adding New Deployments

To add a new client deployment:

1. Create a new values file: `values/deployments/{client}-{env}.yaml`
2. Copy from existing deployment or example
3. Customize for your client
4. Commit and push - ArgoCD will auto-discover

Example:
```bash
cp values/deployments/acme-staging.yaml values/deployments/newclient-staging.yaml
# Edit values/deployments/newclient-staging.yaml
git add values/deployments/newclient-staging.yaml
git commit -m "feat: add newclient staging deployment"
git push
```

## Configuration Guidelines

### Naming Convention

- **Infrastructure**: `main.yaml` (single consolidated configuration file)
- **Deployments**: `{client}-{environment}.yaml` (e.g., `acme-staging.yaml`)

### Secrets

**Never commit secrets to this directory.** Use External Secrets Operator (ESO) to sync secrets from:
- GCP Secret Manager
- AWS Secrets Manager
- Azure Key Vault

See `infrastructure/external-secrets/` for ExternalSecret definitions.

### Structure

Keep values files flat and well-commented:

```yaml
# Good
global:
  domain: example.com
  namespace: app-staging

postgresql:
  enabled: true
  auth:
    database: myapp

# Avoid deep nesting
```

## Migration from Old Structure

This directory was created to consolidate configurations previously scattered across:
- `charts/argocd-infrastructure/values.yaml` → `values/infrastructure/main.yaml`
- `infrastructure/*/values.yaml` → `values/infrastructure/{component}.yaml`
- `deployments/{client}-{env}/values.yaml` → `values/deployments/{client}-{env}.yaml`

The old `deployments/` marker directories have been removed. ApplicationSet now directly scans YAML files in `values/deployments/` for auto-discovery.
